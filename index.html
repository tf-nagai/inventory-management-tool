<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è£œå……è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .header-links {
            text-align: center;
            margin-bottom: 30px;
        }
        .manual-link {
            display: inline-block;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .download-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .download-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
        }
        .download-btn:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .section h2 {
            margin-top: 0;
            color: #34495e;
        }
        .file-input {
            margin-bottom: 15px;
        }
        .file-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .file-input input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .secondary-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            font-size: 14px;
            padding: 8px 20px;
        }
        .secondary-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        .master-status {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .status-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .status-item label {
            margin-top: 8px;
            font-size: 14px;
            color: #555;
        }
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-indicator.loaded {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-indicator.not-loaded {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .results {
            margin-top: 30px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }
        .result-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        .result-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .result-table tr:hover {
            background-color: #e3f2fd;
        }
        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .summary {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        .summary h3 {
            margin-top: 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸª ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è£œå……è¨ˆç®—ãƒ„ãƒ¼ãƒ« v10</h1>
        
        <div class="header-links">
            <a href="manual.html" target="_blank" class="manual-link">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</a>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ ãƒã‚¹ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸€åº¦ç™»éŒ²ã™ã‚Œã°ä¿æŒï¼‰</h2>
            <div class="master-status" id="masterStatus">
                <div class="status-item">
                    <span id="targetProductsStatus" class="status-indicator not-loaded">æœªç™»éŒ²</span>
                    <label>è©²å½“å“ç•ªãƒ‡ãƒ¼ã‚¿</label>
                </div>
                <div class="status-item">
                    <span id="locationMasterStatus" class="status-indicator not-loaded">æœªç™»éŒ²</span>
                    <label>ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿</label>
                </div>
            </div>
            <div class="file-input">
                <label for="targetProducts">è©²å½“å“ç•ª.txt:</label>
                <input type="file" id="targetProducts" accept=".txt,.csv">
            </div>
            <div class="file-input">
                <label for="locationMaster">ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿_0922.csv:</label>
                <input type="file" id="locationMaster" accept=".csv">
            </div>
            <button onclick="clearMasterData()" id="clearMasterBtn" class="secondary-btn">ğŸ—‘ï¸ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š æ—¥æ¬¡æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«</h2>
            <div class="file-input">
                <label for="inventoryData">åœ¨åº«0922.csv:</label>
                <input type="file" id="inventoryData" accept=".csv">
            </div>
            <div class="file-input">
                <label for="demandData">å‰7æ—¥å•†å“åˆ¥åœ¨åº«å›è»¢æ—¥æ•°.csv:</label>
                <input type="file" id="demandData" accept=".csv">
            </div>
        </div>

        <div class="section">
            <button onclick="calculateReplenishment()" id="calculateBtn">ğŸ”„ è£œå……å¿…è¦æ•°ã‚’è¨ˆç®—</button>
        </div>

        <div id="results" class="results" style="display:none;">
            <div class="summary">
                <h3>ğŸ“ˆ è¨ˆç®—çµæœã‚µãƒãƒªãƒ¼</h3>
                <div id="summary"></div>
            </div>
            
            <div class="download-section">
                <button onclick="downloadExcel()" id="downloadBtn" class="download-btn">ğŸ“¥ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                    è¨ˆç®—çµæœã‚’ Excel ãƒ•ã‚¡ã‚¤ãƒ« (.xlsx) ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™
                </p>
            </div>
            
            <div id="detailResults"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let targetProductsData = {};
        let locationMasterData = [];
        let inventoryData = [];
        let demandData = [];
        let currentResults = []; // Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®çµæœãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        
        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç®¡ç†
        let masterDataLoaded = {
            targetProducts: false,
            locationMaster: false
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateMasterStatus();
        });

        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
        function updateMasterStatus() {
            const targetStatus = document.getElementById('targetProductsStatus');
            const locationStatus = document.getElementById('locationMasterStatus');
            
            if (masterDataLoaded.targetProducts) {
                targetStatus.textContent = `ç™»éŒ²æ¸ˆã¿ (${Object.keys(targetProductsData).length}ä»¶)`;
                targetStatus.className = 'status-indicator loaded';
            } else {
                targetStatus.textContent = 'æœªç™»éŒ²';
                targetStatus.className = 'status-indicator not-loaded';
            }
            
            if (masterDataLoaded.locationMaster) {
                locationStatus.textContent = `ç™»éŒ²æ¸ˆã¿ (${locationMasterData.length}ä»¶)`;
                locationStatus.className = 'status-indicator loaded';
            } else {
                locationStatus.textContent = 'æœªç™»éŒ²';
                locationStatus.className = 'status-indicator not-loaded';
            }
        }

        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        function clearMasterData() {
            if (confirm('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè©²å½“å“ç•ªãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                targetProductsData = {};
                locationMasterData = [];
                masterDataLoaded.targetProducts = false;
                masterDataLoaded.locationMaster = false;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('targetProducts').value = '';
                document.getElementById('locationMaster').value = '';
                
                updateMasterStatus();
                showStatus('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            }
        }

        // Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadExcel() {
            if (currentResults.length === 0) {
                showStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            try {
                // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const dateStr = now.toLocaleDateString('ja-JP').replace(/\//g, '-');
                
                // Excelãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
                const worksheetData = [
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                    ['å•†å“ID', 'æ—¥æ™‚å¹³å‡', 'å®‰å…¨åœ¨åº«(3æ—¥åˆ†)', 'ä¸è¶³æ•°', 'è£œå……ãƒ‘ãƒ¬ãƒƒãƒˆæ•°', 'å®Ÿè£œå……æ•°', '1ãƒ‘ãƒ¬åœ¨åº«æ•°'],
                    // ãƒ‡ãƒ¼ã‚¿è¡Œ
                    ...currentResults.map(result => [
                        result.productId,
                        result.dailyDemand,
                        result.safetyStock,
                        result.shortfall,
                        result.palletsNeeded,
                        result.actualReplenishment,
                        result.palletQty
                    ])
                ];

                // ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                const totalProducts = currentResults.length;
                const replenishmentNeeded = currentResults.filter(r => r.shortfall > 0).length;
                
                // ç©ºè¡Œã‚’è¿½åŠ ã—ã¦ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                worksheetData.push([]);
                worksheetData.push(['=== è¨ˆç®—çµæœã‚µãƒãƒªãƒ¼ ===']);
                worksheetData.push(['å¯¾è±¡å•†å“æ•°', totalProducts]);
                worksheetData.push(['è£œå……ãŒå¿…è¦ãªå•†å“', replenishmentNeeded]);
                worksheetData.push(['è¨ˆç®—åŸºæº–', '3æ—¥åˆ†ã®å®‰å…¨åœ¨åº«']);
                worksheetData.push(['è¨ˆç®—å®Ÿè¡Œæ—¥æ™‚', now.toLocaleString('ja-JP')]);

                // ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                // ã‚«ãƒ©ãƒ å¹…ã‚’èª¿æ•´
                worksheet['!cols'] = [
                    { width: 12 }, // å•†å“ID
                    { width: 10 }, // æ—¥æ™‚å¹³å‡
                    { width: 15 }, // å®‰å…¨åœ¨åº«
                    { width: 10 }, // ä¸è¶³æ•°
                    { width: 15 }, // è£œå……ãƒ‘ãƒ¬ãƒƒãƒˆæ•°
                    { width: 12 }, // å®Ÿè£œå……æ•°
                    { width: 12 }  // 1ãƒ‘ãƒ¬åœ¨åº«æ•°
                ];

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆå¯èƒ½ãªç¯„å›²ã§ï¼‰
                const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    worksheet[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "34495E" } }
                    };
                }

                // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆ
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'è£œå……è¨ˆç®—çµæœ');

                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const filename = `ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è£œå……è¨ˆç®—çµæœ_${dateStr}_${timestamp.slice(-8)}.xlsx`;

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                XLSX.writeFile(workbook, filename);
                
                showStatus(`Excelãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${filename}ã€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                console.error('Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–¢æ•°
        function readFile(file, encoding = 'UTF-8') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                if (encoding === 'Shift_JIS') {
                    reader.readAsText(file, 'Shift_JIS');
                } else {
                    reader.readAsText(file, 'UTF-8');
                }
            });
        }

        // CSVãƒ‘ãƒ¼ã‚¹é–¢æ•°
        function parseCSV(csvText, hasHeader = true) {
            return new Promise((resolve) => {
                Papa.parse(csvText, {
                    header: hasHeader,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (result) => resolve(result.data),
                    error: (error) => {
                        console.error('CSVè§£æã‚¨ãƒ©ãƒ¼:', error);
                        resolve([]);
                    }
                });
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        document.getElementById('targetProducts').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                try {
                    const text = await readFile(e.target.files[0]);
                    const lines = text.split('\n').filter(line => line.trim());
                    targetProductsData = {};
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å‡¦ç†
                    for (let i = 1; i < lines.length; i++) {
                        const [productId, palletQty] = lines[i].split(',');
                        if (productId && palletQty) {
                            targetProductsData[productId.trim()] = parseInt(palletQty.trim()) || 0;
                        }
                    }
                    masterDataLoaded.targetProducts = true;
                    updateMasterStatus();
                    showStatus(`è©²å½“å“ç•ªãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ (${Object.keys(targetProductsData).length}ä»¶)`, 'success');
                } catch (error) {
                    showStatus('è©²å½“å“ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
        });

        document.getElementById('locationMaster').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                try {
                    const text = await readFile(e.target.files[0]);
                    locationMasterData = await parseCSV(text);
                    masterDataLoaded.locationMaster = true;
                    updateMasterStatus();
                    showStatus(`ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ (${locationMasterData.length}ä»¶)`, 'success');
                } catch (error) {
                    showStatus('ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
        });

        document.getElementById('inventoryData').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                try {
                    const text = await readFile(e.target.files[0]);
                    inventoryData = await parseCSV(text);
                    showStatus(`åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${inventoryData.length}ä»¶)`, 'success');
                } catch (error) {
                    showStatus('åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
        });

        document.getElementById('demandData').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                try {
                    const text = await readFile(e.target.files[0]);
                    demandData = await parseCSV(text);
                    showStatus(`éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${demandData.length}ä»¶)`, 'success');
                } catch (error) {
                    showStatus('éœ€è¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }
        });

        function showStatus(message, type) {
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.querySelector('.container').insertBefore(statusDiv, document.querySelector('.section'));
            
            if (type === 'success') {
                setTimeout(() => statusDiv.remove(), 3000);
            }
        }

        async function calculateReplenishment() {
            try {
                // ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
                if (!masterDataLoaded.targetProducts || Object.keys(targetProductsData).length === 0) {
                    throw new Error('è©²å½“å“ç•ªãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                if (!masterDataLoaded.locationMaster || locationMasterData.length === 0) {
                    throw new Error('ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                if (demandData.length === 0) {
                    throw new Error('éœ€è¦ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                if (inventoryData.length === 0) {
                    throw new Error('åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const calculateBtn = document.getElementById('calculateBtn');
                calculateBtn.disabled = true;
                calculateBtn.textContent = 'è¨ˆç®—ä¸­...';

                // 1. è©²å½“å“ç•ªã®æ—¥æ¬¡éœ€è¦ã‚’è¨ˆç®—
                const dailyDemand = {};
                const targetProductIds = Object.keys(targetProductsData);
                
                for (const productId of targetProductIds) {
                    const productDemandData = demandData.filter(row => {
                        const id = row['å•†å“id'] || row['å•†å“ID'] || row['å•†å“ï¼©ï¼¤'];
                        return String(id) === String(productId);
                    });
                    
                    if (productDemandData.length > 0) {
                        // æœ€æ–°ã®å‡ºè·æ•°å¹³å‡ã‚’ä½¿ç”¨
                        const avgDaily = productDemandData[0]['å‡ºè·æ•°å¹³å‡(æ—¥)'] || productDemandData[0]['å‡ºè·æ•°å¹³å‡ï¼ˆæ—¥ï¼‰'] || 0;
                        dailyDemand[productId] = Math.ceil(avgDaily); // å°æ•°ç‚¹åˆ‡ã‚Šä¸Šã’
                    } else {
                        dailyDemand[productId] = 0;
                    }
                }

                // 2. ç¾åœ¨ã®åœ¨åº«çŠ¶æ³ã‚’åˆ†æï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ¨æ¸¬ã—ã¦å‡¦ç†ï¼‰
                const currentInventory = {};
                const productColumn = findColumn(inventoryData[0], ['å•†å“ID', 'å•†å“ï¼©ï¼¤', 'å•†å“id']);
                const blockColumn = findColumn(inventoryData[0], ['ãƒ–ãƒ­ãƒƒã‚¯åŒºåˆ†', 'ãƒ–ãƒ­ãƒƒã‚¯åˆ†é¡']);
                const qtyColumn = findColumn(inventoryData[0], ['åœ¨åº«', 'åœ¨åº«æ•°', 'æ•°é‡']);
                const locationColumn = findColumn(inventoryData[0], ['ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ­ã‚±', 'å€‰åº«ID']);

                for (const productId of targetProductIds) {
                    currentInventory[productId] = {
                        picking: 0,    // ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒ­ã‚± (01)
                        storage: 0,    // ä¿ç®¡ãƒ­ã‚± (02)
                        total: 0
                    };
                }

                // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
                for (const row of inventoryData) {
                    const productId = String(row[productColumn] || '');
                    const blockType = String(row[blockColumn] || '');
                    const qty = parseInt(row[qtyColumn] || 0);
                    
                    if (targetProductIds.includes(productId) && qty > 0) {
                        if (blockType === '01' || blockType === '1') {
                            currentInventory[productId].picking += qty;
                        } else if (blockType === '02' || blockType === '2') {
                            currentInventory[productId].storage += qty;
                        }
                        currentInventory[productId].total += qty;
                    }
                }

                // 3. è£œå……å¿…è¦æ•°ã‚’è¨ˆç®—
                const replenishmentResults = [];
                let totalReplenishmentNeeded = 0;

                for (const productId of targetProductIds) {
                    const daily = dailyDemand[productId];
                    const current = currentInventory[productId];
                    const palletQty = targetProductsData[productId];
                    
                    // 3æ—¥åˆ†ã®å®‰å…¨åœ¨åº«ã‚’ç¢ºä¿
                    const safetyStock = daily * 3;
                    const shortfall = Math.max(0, safetyStock - current.picking);
                    const palletsNeeded = Math.ceil(shortfall / palletQty);
                    const actualReplenishment = palletsNeeded * palletQty;
                    
                    if (shortfall > 0) {
                        totalReplenishmentNeeded++;
                    }
                    
                    replenishmentResults.push({
                        productId: productId,
                        dailyDemand: daily,
                        safetyStock: safetyStock,
                        currentPicking: current.picking,
                        currentStorage: current.storage,
                        shortfall: shortfall,
                        palletsNeeded: palletsNeeded,
                        actualReplenishment: actualReplenishment,
                        palletQty: palletQty
                    });
                }

                // 4. çµæœã‚’è¡¨ç¤º
                currentResults = replenishmentResults; // Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã«ä¿å­˜
                displayResults(replenishmentResults, totalReplenishmentNeeded);
                
                calculateBtn.disabled = false;
                calculateBtn.textContent = 'ğŸ”„ è£œå……å¿…è¦æ•°ã‚’è¨ˆç®—';
                
            } catch (error) {
                showStatus('è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                document.getElementById('calculateBtn').disabled = false;
                document.getElementById('calculateBtn').textContent = 'ğŸ”„ è£œå……å¿…è¦æ•°ã‚’è¨ˆç®—';
            }
        }

        function findColumn(sampleRow, possibleNames) {
            if (!sampleRow) return null;
            const keys = Object.keys(sampleRow);
            for (const name of possibleNames) {
                const found = keys.find(key => key.includes(name) || key.toLowerCase().includes(name.toLowerCase()));
                if (found) return found;
            }
            return keys[0]; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }

        function displayResults(results, totalNeeded) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const detailDiv = document.getElementById('detailResults');

            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            summaryDiv.innerHTML = `
                <p><strong>å¯¾è±¡å•†å“æ•°:</strong> ${results.length} ä»¶</p>
                <p><strong>è£œå……ãŒå¿…è¦ãªå•†å“:</strong> ${totalNeeded} ä»¶</p>
                <p><strong>è¨ˆç®—åŸºæº–:</strong> 3æ—¥åˆ†ã®å®‰å…¨åœ¨åº«</p>
            `;

            // è©³ç´°çµæœè¡¨ç¤º
            let tableHTML = `
                <h3>ğŸ“‹ å•†å“åˆ¥è£œå……è¨ˆç®—çµæœ</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>å•†å“ID</th>
                            <th>æ—¥æ™‚å¹³å‡</th>
                            <th>å®‰å…¨åœ¨åº«<br>(3æ—¥åˆ†)</th>
                            <th>ä¸è¶³æ•°</th>
                            <th>è£œå……ãƒ‘ãƒ¬ãƒƒãƒˆæ•°</th>
                            <th>å®Ÿè£œå……æ•°</th>
                            <th>1ãƒ‘ãƒ¬åœ¨åº«æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(result => {
                const rowClass = result.shortfall > 0 ? 'highlight' : '';
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${result.productId}</td>
                        <td>${result.dailyDemand.toLocaleString()}</td>
                        <td>${result.safetyStock.toLocaleString()}</td>
                        <td>${result.shortfall.toLocaleString()}</td>
                        <td>${result.palletsNeeded}</td>
                        <td>${result.actualReplenishment.toLocaleString()}</td>
                        <td>${result.palletQty}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            detailDiv.innerHTML = tableHTML;
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>
